version: '3.7'

services:
  analysis:
    build:
      args:
        - BONSAI_HASH
        - HAROS_HASH
        - PACKAGE
        - PACKAGE_ID
        - PACKAGE_NAME
        - ROS_DISTRO

      context: ./package
      dockerfile: Dockerfile.analysis

    environment:
      - PACKAGE
      - PACKAGE_HASH

    image: "davla/thesis:${ANALYSIS_IMAGE}"

    volumes:
      - type: bind
        source: "${RESULTS_DIR}"
        target: /home/ros/results

  base:
    build:
      args:
        - ROS_DISTRO

      context: .
      dockerfile: Dockerfile.base

    image: davla/thesis:base

  bonsai:
    build:
      args:
        - BONSAI_HASH

      context: ./haros
      dockerfile: Dockerfile.bonsai

    image: "davla/thesis:bonsai-${BONSAI_HASH}"


  haros:
    build:
      args:
        - BONSAI_HASH
        - HAROS_HASH

      context: ./haros
      dockerfile: Dockerfile.haros

    image: "davla/thesis:haros-${HAROS_HASH}-bonsai-${BONSAI_HASH}"

  haros-deps:
    build:
      context: ./haros
      dockerfile: Dockerfile.deps

    image: davla/thesis:haros-deps

  package-build:
    build:
      args:
        - PACKAGE_DEVEL
        - PACKAGE_NAME
        - ROS_DISTRO

      context: ./package
      dockerfile: Dockerfile.build

    image: "davla/thesis:${BUILD_IMAGE}"

  dev:
    command: ["bash"]
    environment:
      PACKAGE: mavros/libmavconn
      PACKAGE_HASH: '2881525'

    image: "davla/thesis:haros-884b789-bonsai-3d2b1bb-mavros--libmavconn-2881525"

    volumes:
      - type: bind
        source: ../../../bonsai
        target: /src/bonsai-code

      - type: bind
        source: ../..
        target: /home/ros/haros

      - type: bind
        source: ../massive/results
        target: /home/ros/results
